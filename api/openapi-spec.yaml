openapi: 3.0.3
info:
  title: Frontier Alpha API
  description: |
    AI-Powered Cognitive Factor Intelligence Platform API.

    Frontier Alpha provides sophisticated portfolio analytics, factor analysis, earnings intelligence,
    and risk management tools for modern portfolio management.

    ## Authentication

    Most endpoints require authentication via Bearer token. After logging in through `/api/v1/auth/login`,
    include the access token in the `Authorization` header:

    ```
    Authorization: Bearer <access_token>
    ```

    ## Rate Limiting

    API requests are rate-limited based on your tier:
    - **Free tier**: 100 requests/minute
    - **Pro tier**: 500 requests/minute
    - **API tier**: 1000 requests/minute

    Rate limit headers are included in all responses:
    - `X-RateLimit-Limit`: Maximum requests allowed
    - `X-RateLimit-Remaining`: Requests remaining in current window
    - `X-RateLimit-Reset`: Unix timestamp when the limit resets

    ## Error Codes

    | Code | HTTP Status | Description |
    |------|-------------|-------------|
    | BAD_REQUEST | 400 | Invalid request parameters |
    | UNAUTHORIZED | 401 | Missing or invalid authentication |
    | FORBIDDEN | 403 | Access denied |
    | NOT_FOUND | 404 | Resource not found |
    | VALIDATION_ERROR | 422 | Request validation failed |
    | RATE_LIMITED | 429 | Rate limit exceeded |
    | SERVER_ERROR | 500 | Internal server error |
    | DATABASE_ERROR | 500 | Database operation failed |
    | EXTERNAL_API_ERROR | 502 | External service error |
    | TIMEOUT | 504 | Operation timed out |

  version: 1.0.5
  contact:
    name: Frontier Alpha Support
    email: support@frontier-alpha.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: /api/v1
    description: Production API (v1)
  - url: http://localhost:3000/api/v1
    description: Local development

tags:
  - name: Health
    description: API health and status checks
  - name: Authentication
    description: User authentication and session management
  - name: Portfolio
    description: Portfolio management and analysis
  - name: Positions
    description: Position management (CRUD operations)
  - name: Factors
    description: Factor analysis and exposures
  - name: Quotes
    description: Real-time and historical quotes
  - name: Earnings
    description: Earnings calendar, forecasts, and history
  - name: Alerts
    description: Risk alerts and notifications
  - name: Sentiment
    description: News sentiment analysis
  - name: Options
    description: Options analytics and implied volatility
  - name: ML
    description: ML engine — regime detection, factor attribution, model management
  - name: Tax
    description: Tax optimization — lots, harvesting, wash sales, and reporting
  - name: Broker
    description: Trade execution (paper trading)
  - name: Settings
    description: User settings and preferences
  - name: API Keys
    description: API key management for programmatic access
  - name: Cache
    description: Cache management (admin)
  - name: Errors
    description: Error reporting

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: |
        Returns the health status of the API and its dependencies.
        Use `quick=true` for a fast response without dependency checks.
      operationId: getHealth
      parameters:
        - name: quick
          in: query
          description: Skip dependency checks for faster response
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: API is healthy or degraded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheck'
              example:
                status: healthy
                timestamp: "2024-01-15T10:30:00Z"
                version: "1.0.5"
                environment: production
                checks:
                  api:
                    status: ok
                    latencyMs: 5
                  database:
                    status: ok
                  external:
                    status: ok
                metrics:
                  uptime: 86400
                  memoryUsage: 128
                  requestCount: 10542
        '503':
          description: API is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheck'

  /auth/signup:
    post:
      tags:
        - Authentication
      summary: Create new account
      description: Register a new user account
      operationId: signup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        '201':
          description: Account created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignupResponse'
        '400':
          description: Validation error or duplicate email
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Authentication service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login
      description: Authenticate with email and password
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Authentication service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout
      description: Invalidate current session
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh token
      description: Get new access token using refresh token
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshResponse'
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get current user
      description: Returns the authenticated user's profile and settings
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /portfolio:
    get:
      tags:
        - Portfolio
      summary: Get portfolio summary
      description: Returns portfolio with positions, current values, and P&L
      operationId: getPortfolio
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Portfolio summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PortfolioResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: No portfolio found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /portfolio/risk:
    get:
      tags:
        - Portfolio
      summary: Get portfolio risk metrics
      description: |
        Returns comprehensive risk metrics including VaR, CVaR, Sharpe ratio,
        and Monte Carlo simulation results.
      operationId: getPortfolioRisk
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Risk metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RiskMetricsResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /portfolio/attribution:
    get:
      tags:
        - Portfolio
      summary: Get performance attribution
      description: Returns Brinson-Fachler performance attribution analysis
      operationId: getPortfolioAttribution
      security:
        - bearerAuth: []
      parameters:
        - name: period
          in: query
          description: Attribution period
          schema:
            type: string
            enum: [1W, 1M, 3M, 6M, 1Y, YTD]
            default: 1M
        - name: symbols
          in: query
          description: Comma-separated symbols (optional, uses portfolio if omitted)
          schema:
            type: string
            example: "NVDA,AAPL,MSFT"
      responses:
        '200':
          description: Attribution analysis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AttributionResponse'

  /portfolio/positions:
    get:
      tags:
        - Positions
      summary: List all positions
      description: Returns all positions in the user's portfolio
      operationId: listPositions
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of positions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionListResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Positions
      summary: Add position
      description: Add a new position or average into existing position
      operationId: addPosition
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddPositionRequest'
      responses:
        '201':
          description: Position created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionResponse'
        '200':
          description: Position updated (averaged in)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /portfolio/positions/{id}:
    parameters:
      - name: id
        in: path
        required: true
        description: Position ID
        schema:
          type: string
          format: uuid

    get:
      tags:
        - Positions
      summary: Get position
      description: Returns a single position by ID
      operationId: getPosition
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Position details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionResponse'
        '404':
          description: Position not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Positions
      summary: Update position
      description: Update position shares or cost basis
      operationId: updatePosition
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePositionRequest'
      responses:
        '200':
          description: Position updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Position not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Positions
      summary: Delete position
      description: Remove a position from the portfolio
      operationId: deletePosition
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Position deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteResponse'
        '404':
          description: Position not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /portfolio/factors/{symbols}:
    get:
      tags:
        - Factors
      summary: Get factor exposures
      description: |
        Calculate factor exposures for specified symbols.
        Returns market beta, momentum, volatility, and other factor loadings.
      operationId: getFactorExposures
      parameters:
        - name: symbols
          in: path
          required: true
          description: Comma-separated stock symbols
          schema:
            type: string
            example: "NVDA,AAPL,MSFT"
      responses:
        '200':
          description: Factor exposures
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FactorExposuresResponse'
        '400':
          description: Invalid symbols
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /quotes/{symbol}:
    get:
      tags:
        - Quotes
      summary: Get quote
      description: Returns current quote for a single symbol
      operationId: getQuote
      parameters:
        - name: symbol
          in: path
          required: true
          description: Stock symbol
          schema:
            type: string
            example: AAPL
      responses:
        '200':
          description: Quote data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuoteResponse'
        '400':
          description: Invalid symbol
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /quotes/stream:
    get:
      tags:
        - Quotes
      summary: Stream quotes
      description: |
        Get quotes for multiple symbols. Supports SSE streaming for real-time updates.
        Set `sse=true` for Server-Sent Events streaming.
      operationId: streamQuotes
      parameters:
        - name: symbols
          in: query
          required: true
          description: Comma-separated symbols (max 50)
          schema:
            type: string
            example: "NVDA,AAPL,MSFT,GOOGL"
        - name: sse
          in: query
          description: Enable Server-Sent Events streaming
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Quotes or SSE stream
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuotesResponse'
            text/event-stream:
              schema:
                type: string
                description: SSE stream of quote updates
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /earnings/upcoming:
    get:
      tags:
        - Earnings
      summary: Get upcoming earnings
      description: Returns upcoming earnings calendar with AI-powered recommendations
      operationId: getUpcomingEarnings
      parameters:
        - name: daysAhead
          in: query
          description: Number of days to look ahead
          schema:
            type: integer
            default: 30
            minimum: 1
            maximum: 90
        - name: symbols
          in: query
          description: Filter by symbols (comma-separated)
          schema:
            type: string
            example: "NVDA,AAPL"
      responses:
        '200':
          description: Earnings calendar
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EarningsCalendarResponse'

  /earnings/history/{symbol}:
    get:
      tags:
        - Earnings
      summary: Get earnings history
      description: Returns historical earnings reactions for a symbol
      operationId: getEarningsHistory
      parameters:
        - name: symbol
          in: path
          required: true
          description: Stock symbol
          schema:
            type: string
            example: NVDA
      responses:
        '200':
          description: Historical earnings data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EarningsHistoryResponse'
        '400':
          description: Invalid symbol
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /earnings/forecast/{symbol}:
    get:
      tags:
        - Earnings
      summary: Get earnings forecast
      description: Returns AI-powered earnings forecast and trading recommendation
      operationId: getEarningsForecast
      parameters:
        - name: symbol
          in: path
          required: true
          description: Stock symbol
          schema:
            type: string
            example: NVDA
        - name: reportDate
          in: query
          description: Expected report date (YYYY-MM-DD)
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Earnings forecast
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EarningsForecastResponse'
        '400':
          description: Invalid symbol
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /alerts:
    get:
      tags:
        - Alerts
      summary: Get active alerts
      description: Returns all active risk alerts for the user
      operationId: getAlerts
      responses:
        '200':
          description: Active alerts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertsResponse'

  /alerts/notify:
    post:
      tags:
        - Alerts
      summary: Send alert notifications
      description: Send alert notifications via email
      operationId: sendAlertNotifications
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotifyRequest'
      responses:
        '200':
          description: Notifications sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotifyResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /alerts/factor-drift:
    get:
      tags:
        - Alerts
      summary: Get factor drift targets
      description: Returns default factor targets and predefined strategies
      operationId: getFactorDriftTargets
      responses:
        '200':
          description: Factor drift configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FactorDriftConfigResponse'

    post:
      tags:
        - Alerts
      summary: Check factor drift
      description: Analyze factor drift against targets and generate alerts
      operationId: checkFactorDrift
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FactorDriftRequest'
      responses:
        '200':
          description: Factor drift analysis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FactorDriftResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /alerts/sec-filings:
    get:
      tags:
        - Alerts
      summary: Get SEC filing alerts
      description: Returns recent SEC filings for watchlist symbols
      operationId: getSECFilings
      parameters:
        - name: symbols
          in: query
          description: Comma-separated symbols (defaults to common tickers)
          schema:
            type: string
            example: "AAPL,MSFT,NVDA"
      responses:
        '200':
          description: SEC filing alerts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SECFilingsResponse'

    post:
      tags:
        - Alerts
      summary: Check SEC filings for symbols
      description: Check for new SEC filings for specified symbols
      operationId: checkSECFilings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - symbols
              properties:
                symbols:
                  type: array
                  items:
                    type: string
                  maxItems: 20
                  example: ["AAPL", "MSFT", "NVDA"]
      responses:
        '200':
          description: SEC filing alerts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SECFilingsResponse'

  /sentiment/{symbol}:
    get:
      tags:
        - Sentiment
      summary: Get news sentiment
      description: Returns AI-analyzed news sentiment for a symbol
      operationId: getSentiment
      parameters:
        - name: symbol
          in: path
          required: true
          description: Stock symbol
          schema:
            type: string
            example: NVDA
      responses:
        '200':
          description: Sentiment analysis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SentimentResponse'
        '400':
          description: Invalid symbol
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /options/iv:
    get:
      tags:
        - Options
      summary: Get implied volatility
      description: Returns implied volatility metrics for symbols
      operationId: getImpliedVolatility
      parameters:
        - name: symbols
          in: query
          required: true
          description: Comma-separated symbols (max 10)
          schema:
            type: string
            example: "NVDA,AAPL,TSLA"
      responses:
        '200':
          description: IV data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IVResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /options/chain:
    get:
      tags:
        - Options
      summary: Get options chain
      description: Returns full options chain (calls and puts) for a symbol
      operationId: getOptionsChain
      parameters:
        - name: symbol
          in: query
          required: true
          description: Underlying symbol
          schema:
            type: string
            example: "AAPL"
      responses:
        '200':
          description: Options chain data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OptionsChainResponse'
        '400':
          description: Missing symbol parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /options/greeks:
    get:
      tags:
        - Options
      summary: Get Greeks
      description: |
        Returns Greeks for a single contract (when strike, expiration, type provided)
        or portfolio-level aggregated Greeks (when only symbol provided).
      operationId: getOptionsGreeks
      parameters:
        - name: symbol
          in: query
          required: true
          description: Underlying symbol
          schema:
            type: string
            example: "AAPL"
        - name: strike
          in: query
          required: false
          description: Strike price (for single contract mode)
          schema:
            type: number
            example: 150
        - name: expiration
          in: query
          required: false
          description: Expiration date YYYY-MM-DD (for single contract mode)
          schema:
            type: string
            example: "2026-03-14"
        - name: type
          in: query
          required: false
          description: Option type (for single contract mode)
          schema:
            type: string
            enum: [call, put]
        - name: underlyingPrice
          in: query
          required: false
          description: Override underlying price
          schema:
            type: number
        - name: iv
          in: query
          required: false
          description: Override implied volatility (annualized, e.g. 0.25 = 25%)
          schema:
            type: number
      responses:
        '200':
          description: Greeks data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GreeksResponse'
        '400':
          description: Missing symbol parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /options/strategies:
    get:
      tags:
        - Options
      summary: Get recommended strategies
      description: Returns strategy recommendations based on IV rank and market regime
      operationId: getStrategyRecommendations
      parameters:
        - name: symbol
          in: query
          required: true
          description: Underlying symbol
          schema:
            type: string
            example: "AAPL"
        - name: ivRank
          in: query
          required: false
          description: IV rank 0-100 (auto-fetched if not provided)
          schema:
            type: number
            example: 65
        - name: regime
          in: query
          required: false
          description: Market regime
          schema:
            type: string
            enum: [bull, bear, sideways, volatile]
            default: sideways
      responses:
        '200':
          description: Strategy recommendations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StrategyRecommendationsResponse'
        '400':
          description: Missing symbol parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags:
        - Options
      summary: Analyze a strategy
      description: Build and analyze an options strategy with P&L curve, breakevens, and probability of profit
      operationId: analyzeStrategy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StrategyAnalysisRequest'
      responses:
        '200':
          description: Strategy analysis result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StrategyAnalysisResponse'
        '400':
          description: Invalid strategy type or missing symbol
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /options/vol-surface:
    get:
      tags:
        - Options
      summary: Get volatility surface
      description: Returns IV surface data (strike × expiration × IV) with Greeks heatmap
      operationId: getVolSurface
      parameters:
        - name: symbol
          in: query
          required: true
          description: Underlying symbol
          schema:
            type: string
            example: "AAPL"
      responses:
        '200':
          description: Volatility surface data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VolSurfaceResponse'
        '400':
          description: Missing symbol parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /ml/regime:
    get:
      tags:
        - ML
      summary: Get current market regime
      description: |
        Detect the current market regime (bull, bear, sideways, volatile) using
        a Hidden Markov Model on historical price data. Returns confidence scores,
        per-regime probabilities, and the full transition matrix.
      operationId: getMLRegime
      parameters:
        - name: symbols
          in: query
          description: Comma-separated symbols (uses first for detection, defaults to SPY)
          schema:
            type: string
            default: SPY
            example: AAPL
      responses:
        '200':
          description: Regime detection result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegimeResponse'
        '400':
          description: Insufficient price data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Detection failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /ml/attribution:
    get:
      tags:
        - ML
      summary: Get factor attribution
      description: |
        Compute gradient-based factor attribution with Shapley-inspired values
        for a set of symbols. Returns per-factor contributions, importance scores,
        waterfall chart data, and summary statistics.
      operationId: getMLAttribution
      parameters:
        - name: symbols
          in: query
          description: Comma-separated symbols for portfolio attribution
          schema:
            type: string
            default: AAPL,MSFT,GOOGL
            example: AAPL,MSFT,GOOGL
      responses:
        '200':
          description: Factor attribution result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AttributionResponse'
        '400':
          description: Insufficient data or no factor exposures
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Attribution failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /ml/models:
    get:
      tags:
        - ML
      summary: Get model versions and status
      description: |
        List ML model versions with training metrics and deployment status.
        Supports filtering by model type and status.
      operationId: getMLModels
      parameters:
        - name: type
          in: query
          description: Filter by model type
          schema:
            type: string
            enum:
              - regime_detector
              - neural_factor
        - name: status
          in: query
          description: Filter by model status
          schema:
            type: string
            enum:
              - training
              - validated
              - deployed
              - archived
      responses:
        '200':
          description: Model versions list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelsResponse'
        '500':
          description: Failed to fetch models
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /tax/lots:
    get:
      tags:
        - Tax
      summary: Get tax lots
      description: Returns tax lots for the authenticated user with holding period metadata
      operationId: getTaxLots
      security:
        - bearerAuth: []
      parameters:
        - name: symbol
          in: query
          schema:
            type: string
          description: Filter lots by symbol (e.g., AAPL)
      responses:
        '200':
          description: Tax lots
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/TaxLotsResponse'
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /tax/harvest:
    get:
      tags:
        - Tax
      summary: Get harvesting opportunities
      description: Scans portfolio for tax-loss harvesting opportunities with replacement securities
      operationId: getHarvestingOpportunities
      security:
        - bearerAuth: []
      parameters:
        - name: symbols
          in: query
          schema:
            type: string
          description: Comma-separated symbols to scan (default AAPL,MSFT,GOOGL,NVDA,AMZN)
      responses:
        '200':
          description: Harvesting opportunities
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/HarvestingScanResponse'
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags:
        - Tax
      summary: Execute a harvest
      description: Sells shares at a loss to realize tax-loss harvesting benefit
      operationId: executeHarvest
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HarvestExecutionRequest'
      responses:
        '200':
          description: Harvest execution result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/HarvestExecutionResponse'
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
        '400':
          description: Validation error or insufficient shares
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /tax/wash-sales:
    get:
      tags:
        - Tax
      summary: Get wash sale warnings
      description: Scans transaction history for IRS wash sale violations
      operationId: getWashSales
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Wash sale scan results
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/WashSaleScanResponse'
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /tax/report:
    get:
      tags:
        - Tax
      summary: Get annual tax report
      description: Generates IRS Schedule D / Form 8949 compatible annual tax report
      operationId: getTaxReport
      security:
        - bearerAuth: []
      parameters:
        - name: year
          in: query
          schema:
            type: integer
          description: Tax year (default current year)
        - name: format
          in: query
          schema:
            type: string
            enum: [json, csv]
          description: Export format (default json)
      responses:
        '200':
          description: Annual tax report
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/AnnualTaxReport'
                  meta:
                    $ref: '#/components/schemas/ResponseMeta'
            text/csv:
              schema:
                type: string
        '400':
          description: Invalid year parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /broker/trade:
    get:
      tags:
        - Broker
      summary: Get account or orders
      description: Returns broker account info or order list
      operationId: getBrokerInfo
      parameters:
        - name: action
          in: query
          required: true
          description: Action to perform
          schema:
            type: string
            enum: [account, orders]
      responses:
        '200':
          description: Account or orders
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/BrokerAccountResponse'
                  - $ref: '#/components/schemas/OrderListResponse'

    post:
      tags:
        - Broker
      summary: Submit order
      description: Submit a trade order (paper trading or live with broker configured)
      operationId: submitOrder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderRequest'
      responses:
        '200':
          description: Order submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: Invalid order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Broker
      summary: Cancel order
      description: Cancel a pending order
      operationId: cancelOrder
      parameters:
        - name: orderId
          in: query
          required: true
          description: Order ID to cancel
          schema:
            type: string
      responses:
        '200':
          description: Order canceled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /settings/notifications:
    get:
      tags:
        - Settings
      summary: Get notification settings
      description: Returns current notification preferences
      operationId: getNotificationSettings
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Notification settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationSettingsResponse'

    put:
      tags:
        - Settings
      summary: Update notification settings
      description: Update notification preferences
      operationId: updateNotificationSettings
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotificationSettingsRequest'
      responses:
        '200':
          description: Settings updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationSettingsResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /cache/stats:
    get:
      tags:
        - Cache
      summary: Get cache statistics
      description: Returns cache hit rates and memory usage
      operationId: getCacheStats
      responses:
        '200':
          description: Cache statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CacheStatsResponse'

    post:
      tags:
        - Cache
      summary: Invalidate cache
      description: Invalidate specific cache types
      operationId: invalidateCache
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action
                - type
              properties:
                action:
                  type: string
                  enum: [invalidate]
                type:
                  type: string
                  enum: [quotes, factors, api, all]
      responses:
        '200':
          description: Cache invalidated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CacheInvalidateResponse'

    delete:
      tags:
        - Cache
      summary: Clear all cache
      description: Clear entire cache
      operationId: clearCache
      responses:
        '200':
          description: Cache cleared
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  /api-keys:
    get:
      tags:
        - API Keys
      summary: List API keys
      description: Returns all API keys for the authenticated user with usage stats
      operationId: listApiKeys
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of API keys
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyListResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - API Keys
      summary: Create API key
      description: |
        Create a new API key. The full key is returned ONLY in this response
        and cannot be retrieved again. Store it securely.
      operationId: createApiKey
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateApiKeyRequest'
      responses:
        '200':
          description: API key created (includes the raw key -- save it now)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateApiKeyResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api-keys/{id}:
    parameters:
      - name: id
        in: path
        required: true
        description: API key ID
        schema:
          type: string
          format: uuid

    delete:
      tags:
        - API Keys
      summary: Revoke API key
      description: Permanently revoke an API key. It will no longer authenticate requests.
      operationId: revokeApiKey
      security:
        - bearerAuth: []
      responses:
        '200':
          description: API key revoked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteResponse'
        '404':
          description: API key not found or already revoked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /errors/report:
    post:
      tags:
        - Errors
      summary: Report client error
      description: Submit a client-side error report for monitoring
      operationId: reportError
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ErrorReport'
      responses:
        '200':
          description: Error reported
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Invalid error report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token from /auth/login
    apiKeyHeader:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        API key for programmatic access. Create keys in Settings > API Keys.
        Keys use the `fa_` prefix. Can also be passed as `Authorization: Bearer fa_...`.
    apiKeyBearer:
      type: http
      scheme: bearer
      bearerFormat: API Key
      description: API key passed as Bearer token (must start with `fa_`)

  schemas:
    # Common response schemas
    SuccessResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    ErrorResponse:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              enum:
                - BAD_REQUEST
                - UNAUTHORIZED
                - FORBIDDEN
                - NOT_FOUND
                - VALIDATION_ERROR
                - RATE_LIMITED
                - SERVER_ERROR
                - DATABASE_ERROR
                - EXTERNAL_API_ERROR
                - TIMEOUT
            message:
              type: string
            details:
              type: object
            retryAfter:
              type: integer
              description: Seconds until rate limit resets
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    ResponseMeta:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        requestId:
          type: string
        latencyMs:
          type: integer

    DeleteResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            deleted:
              type: boolean
              example: true
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # Health
    HealthCheck:
      type: object
      required:
        - status
        - timestamp
        - version
        - environment
        - checks
        - metrics
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        timestamp:
          type: string
          format: date-time
        version:
          type: string
        environment:
          type: string
        checks:
          type: object
          properties:
            api:
              type: object
              properties:
                status:
                  type: string
                  enum: [ok, error]
                latencyMs:
                  type: number
            database:
              type: object
              properties:
                status:
                  type: string
                  enum: [ok, error]
                message:
                  type: string
            external:
              type: object
              properties:
                status:
                  type: string
                  enum: [ok, error]
                message:
                  type: string
        metrics:
          type: object
          properties:
            uptime:
              type: number
              description: Uptime in seconds
            memoryUsage:
              type: number
              description: Memory usage in MB
            requestCount:
              type: number

    # Authentication schemas
    SignupRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        name:
          type: string

    SignupResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            user:
              $ref: '#/components/schemas/User'
            session:
              $ref: '#/components/schemas/Session'
            confirmationRequired:
              type: boolean
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    LoginResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            user:
              $ref: '#/components/schemas/User'
            accessToken:
              type: string
            refreshToken:
              type: string
            expiresAt:
              type: integer
            expiresIn:
              type: integer
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    RefreshRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string

    RefreshResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            accessToken:
              type: string
            refreshToken:
              type: string
            expiresAt:
              type: integer
            expiresIn:
              type: integer
            user:
              $ref: '#/components/schemas/User'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        avatarUrl:
          type: string
          format: uri
        createdAt:
          type: string
          format: date-time
        lastSignIn:
          type: string
          format: date-time
        emailConfirmed:
          type: boolean

    Session:
      type: object
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
        expiresAt:
          type: integer

    UserProfileResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            user:
              $ref: '#/components/schemas/User'
            settings:
              type: object
              properties:
                notifications:
                  type: boolean
                theme:
                  type: string
                riskTolerance:
                  type: string
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # Portfolio schemas
    Portfolio:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        positions:
          type: array
          items:
            $ref: '#/components/schemas/PositionWithQuote'
        cash:
          type: number
        totalValue:
          type: number
        currency:
          type: string
          default: USD

    PositionWithQuote:
      type: object
      properties:
        id:
          type: string
          format: uuid
        symbol:
          type: string
        shares:
          type: number
        weight:
          type: number
          description: Portfolio weight (0-1)
        costBasis:
          type: number
        currentPrice:
          type: number
        unrealizedPnL:
          type: number

    PortfolioResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/Portfolio'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # Position schemas
    Position:
      type: object
      properties:
        id:
          type: string
          format: uuid
        symbol:
          type: string
        shares:
          type: number
        costBasis:
          type: number

    AddPositionRequest:
      type: object
      required:
        - symbol
        - shares
        - avgCost
      properties:
        symbol:
          type: string
          example: NVDA
        shares:
          type: number
          minimum: 0.01
          example: 100
        avgCost:
          type: number
          minimum: 0.01
          example: 450.50

    UpdatePositionRequest:
      type: object
      properties:
        shares:
          type: number
          minimum: 0.01
        avgCost:
          type: number
          minimum: 0.01

    PositionResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/Position'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    PositionListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Position'
        meta:
          allOf:
            - $ref: '#/components/schemas/ResponseMeta'
            - type: object
              properties:
                count:
                  type: integer

    # Risk schemas
    RiskMetrics:
      type: object
      properties:
        var95:
          type: number
          description: 95% Value at Risk (annual)
        cvar95:
          type: number
          description: 95% Conditional VaR (annual)
        sharpeRatio:
          type: number
          description: Sharpe ratio (annualized)
        sortinoRatio:
          type: number
          description: Sortino ratio (annualized)
        volatility:
          type: number
          description: Annualized volatility
        maxDrawdown:
          type: number
          description: Maximum drawdown (historical)
        beta:
          type: number
          description: Market beta
        informationRatio:
          type: number
          description: Information ratio vs benchmark
        tailRisk:
          type: number
          description: Average of worst 1% outcomes
        probPositive:
          type: number
          description: Probability of positive annual return

    RiskMetricsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/RiskMetrics'
        meta:
          allOf:
            - $ref: '#/components/schemas/ResponseMeta'
            - type: object
              properties:
                source:
                  type: string
                dataPoints:
                  type: integer
                simulations:
                  type: integer

    # Attribution schemas
    AttributionResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            period:
              type: object
              properties:
                start:
                  type: string
                end:
                  type: string
                label:
                  type: string
            portfolioReturn:
              type: number
            benchmarkReturn:
              type: number
            activeReturn:
              type: number
            allocationEffect:
              type: number
            selectionEffect:
              type: number
            interactionEffect:
              type: number
            sectorAttribution:
              type: array
              items:
                type: object
            factorAttribution:
              type: array
              items:
                type: object
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # Factor schemas
    FactorExposure:
      type: object
      properties:
        factor:
          type: string
        exposure:
          type: number
        tStat:
          type: number
        confidence:
          type: number
        contribution:
          type: number

    FactorExposuresResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          additionalProperties:
            type: array
            items:
              $ref: '#/components/schemas/FactorExposure'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # Quote schemas
    Quote:
      type: object
      properties:
        symbol:
          type: string
        timestamp:
          type: string
          format: date-time
        bid:
          type: number
        ask:
          type: number
        last:
          type: number
        change:
          type: number
        changePercent:
          type: number
        volume:
          type: integer

    QuoteResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/Quote'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    QuotesResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Quote'
        meta:
          allOf:
            - $ref: '#/components/schemas/ResponseMeta'
            - type: object
              properties:
                source:
                  type: string
                count:
                  type: integer

    # Earnings schemas
    EarningsEvent:
      type: object
      properties:
        id:
          type: string
        symbol:
          type: string
        reportDate:
          type: string
          format: date
        reportTime:
          type: string
          enum: [pre_market, post_market, during_market]
        fiscalQuarter:
          type: string
        estimatedEps:
          type: number
        actualEps:
          type: number
        status:
          type: string
          enum: [upcoming, confirmed, reported]
        expectedMove:
          type: number
          description: Expected price move (decimal)
        recommendation:
          type: string
          enum: [hold, reduce, hedge, add]
        explanation:
          type: string

    EarningsCalendarResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/EarningsEvent'
        meta:
          allOf:
            - $ref: '#/components/schemas/ResponseMeta'
            - type: object
              properties:
                source:
                  type: string
                count:
                  type: integer

    HistoricalReaction:
      type: object
      properties:
        reportDate:
          type: string
          format: date
        fiscalQuarter:
          type: string
        estimatedEps:
          type: number
        actualEps:
          type: number
        surprise:
          type: number
        priceMove:
          type: number
        postEarningsDrift:
          type: number
        outcome:
          type: string
          enum: [beat, miss, inline, unknown]

    EarningsHistoryResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            symbol:
              type: string
            reactions:
              type: array
              items:
                $ref: '#/components/schemas/HistoricalReaction'
            summary:
              type: object
              properties:
                quarters:
                  type: integer
                beatRate:
                  type: number
                avgMove:
                  type: number
                avgBeatMove:
                  type: number
                avgMissMove:
                  type: number
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    EarningsForecast:
      type: object
      properties:
        symbol:
          type: string
        reportDate:
          type: string
          format: date
        expectedMove:
          type: number
        expectedDirection:
          type: string
          enum: [up, down, neutral]
        confidence:
          type: number
          minimum: 0
          maximum: 1
        historicalAvgMove:
          type: number
        beatRate:
          type: number
        recommendation:
          type: string
          enum: [hold, reduce, hedge, add]
        explanation:
          type: string
        factors:
          type: object
          properties:
            historicalPattern:
              type: string
            recentTrend:
              type: string
            riskAssessment:
              type: string

    EarningsForecastResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/EarningsForecast'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # Alert schemas
    Alert:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
        severity:
          type: string
          enum: [critical, high, medium, low]
        title:
          type: string
        message:
          type: string
        timestamp:
          type: string
          format: date-time
        acknowledged:
          type: boolean

    AlertsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Alert'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    NotifyRequest:
      type: object
      required:
        - alerts
      properties:
        alerts:
          type: array
          items:
            $ref: '#/components/schemas/Alert'
        userId:
          type: string
        email:
          type: string
          format: email
        mode:
          type: string
          enum: [immediate, digest]
          default: immediate
        settings:
          type: object

    NotifyResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            sent:
              type: integer
            failed:
              type: integer
            results:
              type: array
              items:
                type: object
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    FactorTarget:
      type: object
      properties:
        factor:
          type: string
        target:
          type: number
        tolerance:
          type: number

    FactorDriftRequest:
      type: object
      required:
        - exposures
      properties:
        exposures:
          type: array
          items:
            type: object
            properties:
              factor:
                type: string
              exposure:
                type: number
        targets:
          type: array
          items:
            $ref: '#/components/schemas/FactorTarget'

    FactorDriftResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            alerts:
              type: array
              items:
                $ref: '#/components/schemas/Alert'
            summary:
              type: object
              properties:
                totalFactorsTracked:
                  type: integer
                factorsWithinTolerance:
                  type: integer
                factorsOutsideTolerance:
                  type: integer
                overallHealth:
                  type: string
                  enum: [healthy, warning, critical]
            drifts:
              type: array
              items:
                type: object
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    FactorDriftConfigResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            defaultTargets:
              type: array
              items:
                $ref: '#/components/schemas/FactorTarget'
            strategies:
              type: object
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    SECFiling:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
        title:
          type: string
        accessionNumber:
          type: string
        filedAt:
          type: string
          format: date-time
        url:
          type: string
          format: uri
        cik:
          type: string
        symbol:
          type: string
        companyName:
          type: string
        description:
          type: string

    SECFilingsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            alerts:
              type: array
              items:
                allOf:
                  - $ref: '#/components/schemas/Alert'
                  - type: object
                    properties:
                      filing:
                        $ref: '#/components/schemas/SECFiling'
                      suggestedAction:
                        type: string
            summary:
              type: object
              properties:
                total:
                  type: integer
                critical:
                  type: integer
                high:
                  type: integer
                medium:
                  type: integer
                low:
                  type: integer
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # Sentiment schemas
    SentimentScore:
      type: object
      properties:
        symbol:
          type: string
        overallSentiment:
          type: number
          minimum: -1
          maximum: 1
        sentimentLabel:
          type: string
          enum: [Bearish, Somewhat-Bearish, Neutral, Somewhat-Bullish, Bullish]
        newsCount:
          type: integer
        relevanceScore:
          type: number
        buzzScore:
          type: number
        timestamp:
          type: string
          format: date-time
        sources:
          type: array
          items:
            type: object
            properties:
              title:
                type: string
              source:
                type: string
              url:
                type: string
                format: uri
              sentiment:
                type: number
              relevance:
                type: number
              publishedAt:
                type: string
                format: date-time

    SentimentResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/SentimentScore'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # Options/IV schemas
    IVData:
      type: object
      properties:
        symbol:
          type: string
        ivRank:
          type: number
        ivPercentile:
          type: number
        atmIV:
          type: number
        iv30:
          type: number
        putCallRatio:
          type: number
        expectedMove:
          type: object
          properties:
            weekly:
              type: number
            monthly:
              type: number
            quarterly:
              type: number
        skew:
          type: number
        timestamp:
          type: string
          format: date-time
        signal:
          type: string
          enum: [high_iv, low_iv, neutral]
        recommendation:
          type: string

    IVResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            symbols:
              type: object
              additionalProperties:
                $ref: '#/components/schemas/IVData'
            portfolio:
              type: object
              properties:
                averageIV:
                  type: number
                averageIVRank:
                  type: number
                highIVPositions:
                  type: array
                  items:
                    type: string
                lowIVPositions:
                  type: array
                  items:
                    type: string
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # Broker schemas
    OrderRequest:
      type: object
      required:
        - symbol
        - qty
        - side
        - type
      properties:
        symbol:
          type: string
        qty:
          type: number
          minimum: 1
        side:
          type: string
          enum: [buy, sell]
        type:
          type: string
          enum: [market, limit, stop, stop_limit]
        timeInForce:
          type: string
          enum: [day, gtc, ioc, fok]
          default: day
        limitPrice:
          type: number
        stopPrice:
          type: number

    Order:
      type: object
      properties:
        id:
          type: string
        symbol:
          type: string
        qty:
          type: number
        side:
          type: string
        type:
          type: string
        status:
          type: string
        filledQty:
          type: number
        filledAvgPrice:
          type: number
        createdAt:
          type: string
          format: date-time

    OrderResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            order:
              $ref: '#/components/schemas/Order'
            broker:
              type: string
            paperTrading:
              type: boolean
            message:
              type: string
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    OrderListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            orders:
              type: array
              items:
                $ref: '#/components/schemas/Order'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    BrokerAccountResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            account:
              type: object
              properties:
                id:
                  type: string
                status:
                  type: string
                currency:
                  type: string
                buyingPower:
                  type: number
                cash:
                  type: number
                portfolioValue:
                  type: number
            brokerConnected:
              type: boolean
            brokerType:
              type: string
            paperTrading:
              type: boolean
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # Settings schemas
    NotificationSettings:
      type: object
      properties:
        userId:
          type: string
        email:
          type: string
          format: email
        emailEnabled:
          type: boolean
        severityThreshold:
          type: string
          enum: [critical, high, medium, low]
        alertTypes:
          type: array
          items:
            type: string
        digestFrequency:
          type: string
          enum: [immediate, hourly, daily]

    NotificationSettingsRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        emailEnabled:
          type: boolean
        severityThreshold:
          type: string
          enum: [critical, high, medium, low]
        alertTypes:
          type: array
          items:
            type: string
        digestFrequency:
          type: string
          enum: [immediate, hourly, daily]

    NotificationSettingsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/NotificationSettings'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # Cache schemas
    CacheStatsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            enabled:
              type: boolean
            connected:
              type: boolean
            stats:
              type: object
              properties:
                hits:
                  type: integer
                misses:
                  type: integer
                hitRate:
                  type: string
                sets:
                  type: integer
                deletes:
                  type: integer
                errors:
                  type: integer
            memory:
              type: object
              properties:
                entries:
                  type: integer
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    CacheInvalidateResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            type:
              type: string
            deleted:
              oneOf:
                - type: integer
                - type: string
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # API Key schemas
    ApiKey:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: Trading Bot
        permissions:
          type: object
          properties:
            read:
              type: boolean
            write:
              type: boolean
        rate_limit:
          type: integer
          description: Maximum requests per minute
          example: 1000
        created_at:
          type: string
          format: date-time
        last_used_at:
          type: string
          format: date-time
          nullable: true
        revoked_at:
          type: string
          format: date-time
          nullable: true
        usage_count:
          type: integer
          description: Total number of requests made with this key

    ApiKeyListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/ApiKey'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    CreateApiKeyRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          example: Trading Bot
          minLength: 1
          maxLength: 100
        permissions:
          type: object
          properties:
            read:
              type: boolean
              default: true
            write:
              type: boolean
              default: false
        rate_limit:
          type: integer
          minimum: 1
          maximum: 10000
          default: 1000

    CreateApiKeyResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
            name:
              type: string
            key:
              type: string
              description: |
                The full API key. This is the ONLY time it will be returned.
                Store it securely -- it cannot be retrieved again.
              example: fa_a1b2c3d4e5f6...
            permissions:
              type: object
            rate_limit:
              type: integer
            created_at:
              type: string
              format: date-time
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # Error report schemas
    ErrorReport:
      type: object
      required:
        - eventId
        - error
      properties:
        eventId:
          type: string
        error:
          type: object
          required:
            - name
            - message
          properties:
            name:
              type: string
            message:
              type: string
            stack:
              type: string
        componentStack:
          type: string
        url:
          type: string
        userAgent:
          type: string
        timestamp:
          type: string
          format: date-time

    # ML Engine schemas
    RegimeResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            regime:
              type: string
              enum: [bull, bear, sideways, volatile]
              description: Current detected market regime
            confidence:
              type: number
              minimum: 0
              maximum: 1
              description: Confidence in the detected regime (0-1)
            probabilities:
              type: object
              properties:
                bull:
                  type: number
                bear:
                  type: number
                sideways:
                  type: number
                volatile:
                  type: number
              description: Per-regime probability distribution
            transitions:
              type: object
              description: Regime transition probability matrix
              additionalProperties:
                type: object
                properties:
                  bull:
                    type: number
                  bear:
                    type: number
                  sideways:
                    type: number
                  volatile:
                    type: number
            symbol:
              type: string
              description: Symbol used for detection
            timestamp:
              type: string
              format: date-time
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    FactorContribution:
      type: object
      properties:
        factor:
          type: string
        exposure:
          type: number
        factorReturn:
          type: number
        contribution:
          type: number
        gradientImportance:
          type: number
        shapleyValue:
          type: number
        direction:
          type: string
          enum: [positive, negative]
        percentOfTotal:
          type: number

    WaterfallItem:
      type: object
      properties:
        label:
          type: string
        start:
          type: number
        end:
          type: number
        value:
          type: number
        type:
          type: string
          enum: [positive, negative, total, residual]

    AttributionSummary:
      type: object
      properties:
        positiveCount:
          type: integer
        negativeCount:
          type: integer
        totalPositive:
          type: number
        totalNegative:
          type: number
        topPositive:
          type: string
          nullable: true
        topNegative:
          type: string
          nullable: true
        rSquared:
          type: number

    AttributionResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            totalReturn:
              type: number
            factorReturn:
              type: number
            residualReturn:
              type: number
            factors:
              type: array
              items:
                $ref: '#/components/schemas/FactorContribution'
            waterfall:
              type: array
              items:
                $ref: '#/components/schemas/WaterfallItem'
            summary:
              $ref: '#/components/schemas/AttributionSummary'
            symbols:
              type: array
              items:
                type: string
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    ModelVersion:
      type: object
      properties:
        id:
          type: string
        model_type:
          type: string
          enum: [regime_detector, neural_factor]
        version:
          type: string
        status:
          type: string
          enum: [training, validated, deployed, archived]
        metrics:
          type: object
          description: Model performance metrics (varies by model type)
        trained_at:
          type: string
          format: date-time
        data_points:
          type: integer

    ModelsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            models:
              type: array
              items:
                $ref: '#/components/schemas/ModelVersion'
            count:
              type: integer
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # Options Intelligence schemas
    OptionContract:
      type: object
      properties:
        strike:
          type: number
          description: Strike price
        expiration:
          type: string
          description: Expiration date (YYYY-MM-DD)
        bid:
          type: number
        ask:
          type: number
        last:
          type: number
        volume:
          type: integer
        openInterest:
          type: integer
        impliedVolatility:
          type: number
          description: Annualized IV (e.g. 0.25 = 25%)
        type:
          type: string
          enum: [call, put]

    OptionsChainResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            symbol:
              type: string
            expirations:
              type: array
              items:
                type: string
            calls:
              type: array
              items:
                $ref: '#/components/schemas/OptionContract'
            puts:
              type: array
              items:
                $ref: '#/components/schemas/OptionContract'
            underlyingPrice:
              type: number
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    GreeksData:
      type: object
      properties:
        delta:
          type: number
        gamma:
          type: number
        theta:
          type: number
          description: Per calendar day
        vega:
          type: number
          description: Per 1% IV move
        rho:
          type: number
          description: Per 1% rate move

    GreeksResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            mode:
              type: string
              enum: [contract, portfolio]
              description: Whether response is for single contract or portfolio
            greeks:
              type: object
              description: Greeks data (structure varies by mode)
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    StrategyAnalysisRequest:
      type: object
      required:
        - type
        - symbol
      properties:
        type:
          type: string
          enum: [covered_call, protective_put, bull_call_spread, bear_put_spread, iron_condor, straddle, strangle]
          description: Strategy type to analyze
        symbol:
          type: string
          description: Underlying symbol
        underlyingPrice:
          type: number
          description: Override underlying price (auto-fetched if omitted)
        expiration:
          type: string
          description: Expiration date (YYYY-MM-DD, defaults to 30 days out)
        strikes:
          type: array
          items:
            type: number
          description: Strike prices (strategy-dependent ordering)
        premiums:
          type: array
          items:
            type: number
          description: Per-leg premiums
        iv:
          type: number
          description: Implied volatility override (e.g. 0.25 = 25%)

    StrategyAnalysisResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            strategy:
              type: object
              description: Strategy definition with legs
            maxProfit:
              type: number
            maxLoss:
              type: number
            breakevens:
              type: array
              items:
                type: number
            probabilityOfProfit:
              type: number
              minimum: 0
              maximum: 1
            netDebit:
              type: number
              description: Positive = debit, negative = credit
            riskRewardRatio:
              type: number
            pnlData:
              type: array
              items:
                type: object
                properties:
                  price:
                    type: number
                  profit:
                    type: number
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    StrategyRecommendation:
      type: object
      properties:
        type:
          type: string
          enum: [covered_call, protective_put, bull_call_spread, bear_put_spread, iron_condor, straddle, strangle]
        name:
          type: string
        rationale:
          type: string
        outlook:
          type: string
          enum: [bullish, bearish, neutral, volatile]
        score:
          type: number
          minimum: 0
          maximum: 1

    StrategyRecommendationsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            symbol:
              type: string
            ivRank:
              type: number
            regime:
              type: string
            recommendations:
              type: array
              items:
                $ref: '#/components/schemas/StrategyRecommendation'
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    VolSurfacePoint:
      type: object
      properties:
        strike:
          type: number
        expiration:
          type: string
        iv:
          type: number
          description: Implied volatility at this point

    VolSurfaceResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            symbol:
              type: string
            underlyingPrice:
              type: number
            strikes:
              type: array
              items:
                type: number
            expirations:
              type: array
              items:
                type: string
            surface:
              type: array
              items:
                $ref: '#/components/schemas/VolSurfacePoint'
            heatmap:
              type: object
              description: Greeks heatmap (strike × expiration grid)
        meta:
          $ref: '#/components/schemas/ResponseMeta'

    # ========================
    # Tax Optimization Schemas
    # ========================

    TaxLot:
      type: object
      properties:
        id:
          type: string
        userId:
          type: string
        symbol:
          type: string
        shares:
          type: number
        costBasis:
          type: number
          description: Per-share cost basis
        purchaseDate:
          type: string
          format: date-time
        soldDate:
          type: string
          format: date-time
          nullable: true
        isOpen:
          type: boolean
        holdingDays:
          type: integer
        isShortTerm:
          type: boolean

    TaxLotsResponse:
      type: object
      properties:
        lots:
          type: array
          items:
            $ref: '#/components/schemas/TaxLot'
        count:
          type: integer

    HarvestingOpportunity:
      type: object
      properties:
        symbol:
          type: string
        unrealizedLoss:
          type: number
          description: Negative value
        currentPrice:
          type: number
        costBasis:
          type: number
        totalShares:
          type: number
        estimatedTaxSavings:
          type: number
        shortTermLoss:
          type: number
        longTermLoss:
          type: number
        shortTermTaxSavings:
          type: number
        longTermTaxSavings:
          type: number
        replacements:
          type: array
          items:
            type: object
            properties:
              symbol:
                type: string
              sector:
                type: string
              reason:
                type: string
        lots:
          type: array
          items:
            type: object
            properties:
              lotId:
                type: string
              shares:
                type: number
              costBasis:
                type: number
              purchaseDate:
                type: string
                format: date-time
              unrealizedLoss:
                type: number
              isShortTerm:
                type: boolean
              holdingDays:
                type: integer

    HarvestingScanResponse:
      type: object
      properties:
        opportunities:
          type: array
          items:
            $ref: '#/components/schemas/HarvestingOpportunity'
        totalUnrealizedLosses:
          type: number
        totalEstimatedTaxSavings:
          type: number
        scannedPositions:
          type: integer
        qualifyingPositions:
          type: integer

    HarvestExecutionRequest:
      type: object
      required:
        - symbol
        - shares
        - salePrice
      properties:
        symbol:
          type: string
        shares:
          type: number
        salePrice:
          type: number
        method:
          type: string
          enum: [fifo, lifo, specific]
          description: Cost basis method (default fifo)
        lotIds:
          type: array
          items:
            type: string
          description: Specific lot IDs to sell (for specific identification method)

    HarvestExecutionResponse:
      type: object
      properties:
        totalProceeds:
          type: number
        totalCostBasis:
          type: number
        realizedGain:
          type: number
        isShortTerm:
          type: boolean
        events:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              taxYear:
                type: integer
              eventType:
                type: string
              symbol:
                type: string
              realizedGain:
                type: number
              isWashSale:
                type: boolean
              shares:
                type: number
              salePrice:
                type: number
              costBasis:
                type: number
              saleDate:
                type: string
                format: date-time

    WashSaleViolation:
      type: object
      properties:
        saleLotId:
          type: string
        saleSymbol:
          type: string
        saleDate:
          type: string
          format: date-time
        saleShares:
          type: number
        saleLoss:
          type: number
        replacementLotId:
          type: string
        replacementSymbol:
          type: string
        replacementDate:
          type: string
          format: date-time
        replacementShares:
          type: number
        replacementCostBasis:
          type: number
        disallowedLoss:
          type: number
        adjustedCostBasis:
          type: number
        affectedShares:
          type: number
        matchType:
          type: string
          enum: [same_ticker, substantially_identical]

    WashSaleScanResponse:
      type: object
      properties:
        violations:
          type: array
          items:
            $ref: '#/components/schemas/WashSaleViolation'
        totalDisallowedLosses:
          type: number
        totalAdjustedCostBasis:
          type: number
        scannedEvents:
          type: integer
        violationCount:
          type: integer

    Form8949Row:
      type: object
      properties:
        description:
          type: string
        dateAcquired:
          type: string
        dateSold:
          type: string
        proceeds:
          type: number
        costBasis:
          type: number
        adjustmentCode:
          type: string
          description: "'W' for wash sale, '' for none"
        adjustmentAmount:
          type: number
        gainOrLoss:
          type: number
        isShortTerm:
          type: boolean
        symbol:
          type: string
        shares:
          type: number

    AnnualTaxReport:
      type: object
      properties:
        taxYear:
          type: integer
        userId:
          type: string
        generatedAt:
          type: string
          format: date-time
        summary:
          type: object
          properties:
            taxYear:
              type: integer
            shortTermGains:
              type: number
            shortTermLosses:
              type: number
            longTermGains:
              type: number
            longTermLosses:
              type: number
            netShortTerm:
              type: number
            netLongTerm:
              type: number
            totalRealizedGain:
              type: number
            washSaleAdjustment:
              type: number
            eventCount:
              type: integer
        washSaleDisallowedLosses:
          type: number
        washSaleViolations:
          type: array
          items:
            $ref: '#/components/schemas/WashSaleViolation'
        harvestingSavingsEstimate:
          type: number
        harvestingOpportunitiesCount:
          type: integer
        shortTermTransactions:
          type: array
          items:
            $ref: '#/components/schemas/Form8949Row'
        longTermTransactions:
          type: array
          items:
            $ref: '#/components/schemas/Form8949Row'
        scheduleD:
          type: object
          properties:
            shortTermProceeds:
              type: number
            shortTermCostBasis:
              type: number
            shortTermAdjustments:
              type: number
            shortTermGainOrLoss:
              type: number
            longTermProceeds:
              type: number
            longTermCostBasis:
              type: number
            longTermAdjustments:
              type: number
            longTermGainOrLoss:
              type: number
            netGainOrLoss:
              type: number
